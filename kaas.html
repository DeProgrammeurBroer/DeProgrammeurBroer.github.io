<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ik zie ik zie Manon eet brie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap'); /* Hacker font */
        
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --input-bg: #fff;
        }

        body.dark-mode {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --card-bg: #1f2937;
            --input-bg: #374151;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
            overflow: hidden; /* Prevent scroll */
            touch-action: none; /* Better tapping on mobile */
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }

        /* Use dvh (dynamic viewport height) for better mobile support with address bars */
        .screen { 
            display: none; 
            height: 100vh; 
            height: 100dvh; 
            width: 100vw; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            position: relative; 
        }
        .screen.active { display: flex; }

        /* Dark Mode Overrides for Specific Elements */
        body.dark-mode .screen { background-color: var(--bg-color); }
        body.dark-mode .bg-white { background-color: var(--card-bg); color: var(--text-color); }
        body.dark-mode .text-gray-800 { color: #f3f4f6; }
        body.dark-mode .text-gray-700 { color: #d1d5db; }
        body.dark-mode .text-gray-600 { color: #9ca3af; }
        body.dark-mode .bg-yellow-50 { background-color: #374151; color: #f3f4f6; border-color: #4b5563; }
        body.dark-mode .bg-gray-100 { background-color: #111827; }
        body.dark-mode input { background-color: var(--input-bg); color: var(--text-color); border-color: #4b5563; }
        body.dark-mode #lobby-code { background-color: #374151; border-color: #4b5563; }

        /* Floating wrong guesses */
        .floating-word {
            position: absolute;
            font-weight: bold;
            color: rgba(0,0,0,0.6);
            font-size: 1.2rem;
            animation: popIn 0.3s ease-out;
            pointer-events: none;
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 0;
            white-space: nowrap;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Cheese Loader */
        .cheese-spinner {
            font-size: 3rem;
            animation: spin 2s infinite linear;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .game-input {
            border: 2px solid #fbbf24; 
            outline: none;
            transition: all 0.2s;
            -webkit-appearance: none; /* Remove iOS default styles */
        }
        .game-input:focus {
            border-color: #d97706;
            box-shadow: 0 0 10px rgba(217, 119, 6, 0.3);
        }

        .btn-primary {
            background-color: #fbbf24;
            color: #78350f;
            font-weight: bold;
            transition: transform 0.1s;
            touch-action: manipulation; /* Improves touch response */
        }
        .btn-primary:active { transform: scale(0.95); }

        /* --- TROLL EFFECTS CSS --- */
        .troll-disco { animation: disco 0.5s infinite; }
        @keyframes disco {
            0% { filter: hue-rotate(0deg) invert(0); }
            50% { filter: hue-rotate(180deg) invert(1); }
            100% { filter: hue-rotate(360deg) invert(0); }
        }
        .troll-australia { transform: rotate(180deg); }
        .troll-tiny { transform: scale(0.2); }

        /* --- SHAKE EFFECTS --- */
        .shake-soft { animation: shake 0.5s; }
        .shake-hard { animation: shake 0.5s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* --- CHEESE CONFETTI --- */
        .cheese-confetti {
            position: fixed;
            top: -50px;
            font-size: 2rem;
            z-index: 100;
            pointer-events: none;
            animation: fall linear forwards;
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(720deg); }
        }

        /* --- CHAT STYLES --- */
        .chat-message {
            padding: 6px 10px;
            border-radius: 12px;
            max-width: 85%;
            font-size: 0.9rem;
            word-wrap: break-word;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .chat-message.me {
            align-self: flex-end;
            background-color: #fcd34d; /* yellow-300 */
            color: #78350f;
            border-bottom-right-radius: 2px;
        }
        .chat-message.them {
            align-self: flex-start;
            background-color: white;
            border: 1px solid #e5e7eb;
            color: #374151;
            border-bottom-left-radius: 2px;
        }
        body.dark-mode .chat-message.them {
            background-color: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        
        /* Popups Animation */
        .popup-enter {
            animation: popInChat 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popInChat {
            from { opacity: 0; transform: scale(0.8) translate(0, -10px); }
            to { opacity: 1; transform: scale(1) translate(0, 0); }
        }

        /* --- MINIGAME STYLES --- */
        .fly {
            position: absolute;
            font-size: 24px;
            user-select: none;
            cursor: pointer;
            transition: transform 0.1s linear;
            z-index: 10;
        }
        .fly.dead {
            transform: scale(0);
            transition: transform 0.2s;
            pointer-events: none;
        }
        .picnic-bg {
            background-color: #fff;
            background-image: linear-gradient(90deg, rgba(200,0,0,.15) 50%, transparent 50%),
            linear-gradient(rgba(200,0,0,.15) 50%, transparent 50%);
            background-size: 50px 50px;
        }
        body.dark-mode .picnic-bg {
            background-color: #111827;
            background-image: linear-gradient(90deg, rgba(200,50,50,.2) 50%, transparent 50%),
            linear-gradient(rgba(200,50,50,.2) 50%, transparent 50%);
        }

        .main-cheese {
            font-size: 80px;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 5;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        /* Cheat Menu Styles */
        .cheat-overlay {
            background: rgba(0, 0, 0, 0.85);
            font-family: 'VT323', monospace;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        .cheat-btn {
            border: 1px solid #0f0;
            background: rgba(0, 255, 0, 0.1);
            color: #0f0;
            padding: 8px;
            margin: 4px;
            font-family: 'VT323', monospace;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cheat-btn:hover { background: #0f0; color: #000; }
        .cheat-input {
            background: black;
            border: 1px solid #0f0;
            color: #0f0;
            font-family: 'VT323', monospace;
            padding: 5px;
        }
        
        /* Settings Slider */
        input[type=range] {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fbbf24;
            cursor: pointer;
            border: 2px solid #d97706;
        }

        /* Sparkling Animation for AI buttons */
        .sparkle-btn {
            position: relative;
            overflow: hidden;
        }
        .sparkle-btn::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
            transform: rotate(45deg);
            animation: sparkle 3s infinite;
        }
        @keyframes sparkle {
            0% { transform: translate(-100%, -100%) rotate(45deg); }
            100% { transform: translate(100%, 100%) rotate(45deg); }
        }

        /* Leaderboard Styles */
        .leaderboard-row:nth-child(1) { color: #d97706; font-weight: 800; font-size: 1.1em; } /* Gold */
        .leaderboard-row:nth-child(2) { color: #9ca3af; font-weight: 700; } /* Silver */
        .leaderboard-row:nth-child(3) { color: #b45309; font-weight: 700; } /* Bronze */

    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg z-50 hidden transition-opacity duration-300">
        <span id="toast-msg">Melding</span>
    </div>
    
    <!-- MANONSCARE OVERLAY (Hidden by default) -->
    <!-- Force Z-index 9999 and full screen fixed -->
    <div id="screen-scare" class="fixed inset-0 z-[9999] hidden bg-black flex items-center justify-center w-full h-full">
        <img src="Manonscare.jpeg" alt="Scare" class="max-w-full max-h-full object-contain pointer-events-none w-full h-full">
    </div>

    <!-- CHEAT MENU MODAL -->
    <div id="cheat-menu" class="fixed inset-0 cheat-overlay z-[100] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-black border-2 border-green-500 p-6 rounded shadow-[0_0_20px_#0f0] w-full max-w-lg overflow-y-auto max-h-[90vh]">
            <h2 class="text-4xl text-center mb-4 border-b border-green-500 pb-2">HACKER MENU_</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="col-span-1 sm:col-span-2">
                    <p class="mb-1 text-sm opacity-70">>> SELF HELP</p>
                    <button id="btn-cheat-reveal" class="cheat-btn w-full">REVEAL SOLUTION</button>
                    <button id="btn-cheat-hint" class="cheat-btn w-full">FORCE 1st LETTER</button>
                </div>
                <div class="col-span-1 sm:col-span-2 mt-4">
                    <p class="mb-1 text-sm opacity-70">>> TROLL EVERYONE (10 SECONDS)</p>
                </div>
                <button id="btn-cheat-scare" class="cheat-btn col-span-1 sm:col-span-2 border-red-500 text-red-500 hover:bg-red-900 font-bold">MANONSCARE üëª</button>
                <button id="btn-cheat-disco" class="cheat-btn">DISCO PARTY</button>
                <button id="btn-cheat-australia" class="cheat-btn">AUSTRALIA MODE</button>
                <button id="btn-cheat-tiny" class="cheat-btn">ANT MODE</button>
                <div class="col-span-1 sm:col-span-2 flex gap-2 mt-2">
                    <input id="inp-cheat-spam" type="text" class="cheat-input flex-1" placeholder="SPAM WORD...">
                    <button id="btn-cheat-spam" class="cheat-btn">START SPAM</button>
                </div>
            </div>
            <button onclick="document.getElementById('cheat-menu').classList.add('hidden')" class="text-red-500 hover:text-red-400 mt-4 text-center w-full underline">>> EXIT HACK_</button>
        </div>
    </div>

    <!-- 1. AUTH / LOADING SCREEN -->
    <div id="screen-loading" class="screen active bg-white p-6 text-center">
        <div class="cheese-spinner mb-4">üßÄ</div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">Verbinden met server...</h2>
        <p class="text-sm text-gray-600 mb-6" id="loading-text">Even geduld...</p>
        
        <!-- Error Container (Hidden by default) -->
        <div id="loading-error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-left">
            <h3 class="font-bold text-red-700 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Verbindingsfout</h3>
            <p class="text-sm text-red-600 mb-3" id="error-details">...</p>
            <p class="text-xs text-gray-500 mb-4">
                <strong>Tip:</strong> Als je dit bestand direct opent op je telefoon (content:// of file://), werkt multiplayer niet. Upload dit bestand naar een website (zoals Netlify Drop of Tiiny.host) en deel de link.
            </p>
            <button onclick="window.location.reload()" class="w-full bg-red-100 text-red-700 font-bold py-2 rounded hover:bg-red-200">
                Probeer opnieuw
            </button>
        </div>
    </div>

    <!-- 2. LOGIN SCREEN -->
    <div id="screen-login" class="screen overflow-y-auto relative">
        <div class="w-full max-w-md p-4">
            <h1 class="text-4xl font-bold text-yellow-600 mb-2 text-center">Ik zie ik zie... üëÅÔ∏è</h1>
            <h2 class="text-xl text-yellow-800 mb-8 font-light text-center">Manon eet brie üßÄ</h2>
            
            <div class="bg-white p-6 rounded-2xl shadow-xl w-full">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Je naam</label>
                    <input id="inp-name" type="text" class="game-input w-full p-3 rounded-lg bg-yellow-50" placeholder="Bijv. Manon">
                </div>
                <div class="flex gap-4 mb-4">
                    <button id="btn-create-room" class="btn-primary flex-1 py-3 rounded-lg hover:bg-yellow-400">
                        <i class="fas fa-plus mr-2"></i>Nieuwe Kamer
                    </button>
                </div>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400">of doe mee</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <div class="flex gap-2 mt-4">
                    <input id="inp-room-code" type="text" class="game-input flex-1 p-3 rounded-lg bg-yellow-50 uppercase tracking-widest text-center" placeholder="CODE" maxlength="4">
                    <button id="btn-join-room" class="bg-yellow-100 text-yellow-800 font-bold px-6 rounded-lg hover:bg-yellow-200">
                        Join
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. LOBBY SCREEN -->
    <div id="screen-lobby" class="screen bg-white overflow-y-auto relative">
        
        <!-- LEAVE LOBBY BUTTON -->
        <button id="btn-leave-lobby" class="absolute top-4 left-20 bg-red-100 text-red-500 w-12 h-12 rounded-full shadow-lg z-30 flex items-center justify-center text-xl hover:bg-red-200 transition-colors border-2 border-white">
            <i class="fas fa-times"></i>
        </button>

        <!-- FLOATING CHAT TOGGLE (Top-Left) -->
        <button id="btn-chat-toggle" class="absolute top-4 left-4 bg-yellow-400 text-yellow-900 w-12 h-12 rounded-full shadow-lg z-30 flex items-center justify-center text-xl hover:scale-110 transition-transform active:scale-95">
            <i class="fas fa-comment-dots"></i>
            <span id="chat-notification" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full hidden border-2 border-white font-bold animate-bounce">!</span>
        </button>

        <!-- FLOATING SETTINGS TOGGLE (Top-Right) -->
        <button id="btn-settings-toggle" class="absolute top-4 right-4 bg-gray-200 text-gray-700 w-12 h-12 rounded-full shadow-lg z-30 flex items-center justify-center text-xl hover:scale-110 transition-transform active:scale-95 border border-gray-300">
            <i class="fas fa-cog"></i>
        </button>

        <!-- CHAT POPUP BUBBLE -->
        <div id="chat-popup" class="absolute top-16 left-4 w-72 bg-white border-4 border-yellow-300 rounded-3xl rounded-tl-none shadow-2xl z-30 hidden flex-col p-4 origin-top-left transition-all popup-enter">
            <h3 class="font-bold text-yellow-800 mb-2 text-sm flex items-center justify-between">
                <span><i class="far fa-comments mr-1"></i> Kletsen</span>
                <button onclick="document.getElementById('chat-popup').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </h3>
            <div id="lobby-chat-messages" class="bg-yellow-50/50 border border-yellow-200 h-48 rounded-xl p-2 overflow-y-auto flex flex-col mb-2 shadow-inner">
                <div class="text-center text-xs text-gray-400 italic mt-2">Nog geen berichten...</div>
            </div>
            <div class="flex gap-2">
                <input id="inp-lobby-chat" type="text" class="game-input flex-1 p-2 rounded-lg text-sm" placeholder="Zeg hallo..." autocomplete="off">
                <button id="btn-lobby-chat-send" class="bg-yellow-400 text-yellow-900 font-bold w-10 rounded-lg hover:bg-yellow-500 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- SETTINGS POPUP BUBBLE -->
        <div id="settings-popup" class="absolute top-16 right-4 w-72 bg-white border-4 border-gray-300 rounded-3xl rounded-tr-none shadow-2xl z-30 hidden flex-col p-4 origin-top-right transition-all popup-enter">
            <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center justify-between">
                <span><i class="fas fa-sliders-h mr-1"></i> Instellingen</span>
                <button onclick="document.getElementById('settings-popup').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </h3>
            
            <div class="space-y-4">
                <!-- Volume -->
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase flex justify-between">
                        Muziek Volume <span id="vol-display">40%</span>
                    </label>
                    <input type="range" id="inp-volume" min="0" max="100" value="40" class="mt-1">
                </div>

                <!-- SFX Toggle -->
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium"><i class="fas fa-volume-up w-5"></i> Geluidseffecten</span>
                    <button id="btn-toggle-sfx" class="bg-green-500 w-10 h-6 rounded-full relative transition-colors">
                        <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                    </button>
                </div>

                <!-- Dark Mode -->
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium"><i class="fas fa-moon w-5"></i> Donkere Modus</span>
                    <button id="btn-toggle-dark" class="bg-gray-300 w-10 h-6 rounded-full relative transition-colors">
                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                    </button>
                </div>
                
                <!-- AI Bot Button -->
                <button id="btn-add-ai" class="w-full py-2 bg-purple-100 text-purple-700 font-bold rounded hover:bg-purple-200 transition-colors border border-purple-200 text-sm">
                    <i class="fas fa-robot mr-1"></i> Voeg AI Speler toe
                </button>

                <!-- Fullscreen -->
                <button id="btn-fullscreen" class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm font-bold text-gray-700">
                    <i class="fas fa-expand mr-1"></i> Volledig Scherm
                </button>
            </div>
        </div>

        <div class="w-full max-w-md p-4 mt-8">
            <div class="bg-yellow-50 p-6 rounded-2xl shadow-lg text-center w-full">
                <h2 class="text-2xl font-bold text-yellow-800 mb-2">Lobby: <span id="lobby-code" class="font-mono text-3xl select-all cursor-pointer bg-white px-2 rounded border border-yellow-200">....</span></h2>
                <p class="text-gray-500 text-sm mb-6">Deel deze code met je tegenspeler</p>

                <div id="player-list" class="space-y-3 mb-6 text-left">
                    <!-- Players injected here -->
                </div>

                <!-- Solo Game Button -->
                <button id="btn-start-solo-game" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 mb-6 shadow-md border-b-4 border-green-700 active:border-0 active:translate-y-1">
                    <i class="fas fa-gamepad mr-2"></i>Speel: Kaas Beschermer (Solo)
                </button>

                <div id="waiting-msg" class="text-gray-400 animate-pulse bg-white p-3 rounded-lg border border-gray-200">
                    Wachten op speler 2...
                </div>

                <!-- Host Controls -->
                <div id="host-controls" class="hidden w-full border-t border-yellow-200 pt-4 text-left mt-4">
                    
                    <label class="block text-gray-700 text-sm font-bold mb-2">1. Spelmodus</label>
                    <select id="sel-gamemode" class="game-input w-full p-2 rounded-lg bg-white cursor-pointer mb-4 h-12">
                        <option value="classic">üé® Klassiek (Ik zie ik zie)</option>
                    </select>

                    <label class="block text-gray-700 text-sm font-bold mb-2">2. Rollen</label>
                    <div class="flex flex-col gap-1 mb-6">
                         <select id="sel-seeker" class="game-input w-full p-2 rounded-lg bg-white cursor-pointer h-12">
                            <!-- Options injected via JS -->
                         </select>
                         <p class="text-xs text-gray-400 mt-1">Kies wie begint als Zoeker</p>
                    </div>

                    <button id="btn-start-game" class="btn-primary w-full py-4 rounded-lg text-lg shadow-md mb-2">
                        Start Spel üßÄ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. NEW MINIGAME SCREEN: CHEESE PROTECTOR -->
    <div id="screen-minigame-cheese" class="screen picnic-bg overflow-hidden select-none">
        <div id="fly-container" class="absolute inset-0 w-full h-full"></div>
        
        <!-- Center Cheese -->
        <div id="center-cheese" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 main-cheese cursor-pointer">üßÄ</div>
        
        <!-- Top HUD -->
        <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-start pointer-events-none z-10">
            <div class="bg-white/90 p-2 rounded-lg shadow border border-red-200 min-w-[80px]">
                <p class="text-xs text-gray-500 font-bold uppercase">Levens</p>
                <div id="cheese-lives-display" class="flex gap-1 text-xl">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            
            <!-- TIMER DISPLAY -->
            <div class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-lg shadow-lg border-2 border-yellow-500 font-mono text-xl font-bold">
                <i class="far fa-clock mr-2"></i><span id="cheese-timer-display">00:00.00</span>
            </div>

            <div class="bg-white/90 p-2 rounded-lg shadow border border-yellow-200 text-right min-w-[80px]">
                <p class="text-xs text-gray-500 font-bold uppercase">Winkel Punten</p>
                <div id="cheese-score-display" class="text-2xl font-bold text-yellow-600">0</div>
            </div>
        </div>

        <!-- Shop & Controls Bottom -->
        <div class="absolute bottom-0 w-full bg-white/95 p-4 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] border-t border-gray-200 z-50">
             <div class="flex justify-between items-center mb-2">
                 <h3 class="font-bold text-yellow-800"><i class="fas fa-store mr-1"></i>Kaas Winkel</h3>
                 <button id="btn-exit-cheese" class="text-xs text-gray-400 underline">Stoppen</button>
             </div>
             <div class="flex gap-2 overflow-x-auto pb-2" id="shop-container">
                 <!-- Shop Items Injected JS -->
             </div>
        </div>
        
        <!-- Game Over Overlay -->
        <div id="cheese-game-over" class="absolute inset-0 bg-black/80 z-[60] flex flex-col items-center justify-center hidden text-white text-center p-4">
            <div class="text-6xl mb-4">ü™∞</div>
            <h2 class="text-3xl font-bold text-red-500 mb-2">KAAS OPGEGETEN!</h2>
            <p class="mb-2">Overleefd: <span id="final-cheese-time" class="text-yellow-400 font-bold font-mono text-2xl">00:00</span></p>

            <!-- HIGHSCORE SECTION -->
            <div id="highscore-section" class="w-full max-w-sm bg-gray-800 p-4 rounded-lg mt-4 hidden">
                <h3 class="text-yellow-400 font-bold text-lg mb-2">üèÜ NIEUWE HIGHSCORE! üèÜ</h3>
                <div class="flex gap-2">
                    <input id="inp-highscore-name" type="text" class="game-input flex-1 p-2 rounded text-black font-bold" placeholder="Jouw naam..." maxlength="10">
                    <button id="btn-submit-highscore" class="bg-green-500 text-white font-bold px-4 rounded hover:bg-green-600">Opslaan</button>
                </div>
            </div>

            <!-- LEADERBOARD LIST -->
            <div class="w-full max-w-sm mt-6 text-left">
                <h3 class="text-gray-400 text-xs font-bold uppercase mb-2 text-center">- Globale Top 10 -</h3>
                <div id="leaderboard-list" class="bg-gray-900 rounded-lg p-2 max-h-48 overflow-y-auto border border-gray-700 text-sm">
                    <div class="text-center text-gray-500 italic">Laden...</div>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button id="btn-retry-cheese" class="bg-yellow-500 text-black px-8 py-3 rounded-full font-bold hover:scale-105 transition-transform">Nog een keer</button>
                <button id="btn-quit-cheese" class="text-gray-400 text-sm underline">Terug</button>
            </div>
        </div>
    </div>

    <!-- 4. SETUP SCREEN (SEEKER - Classic) -->
    <div id="screen-setup" class="screen bg-yellow-50">
        <button id="btn-leave-setup" class="absolute top-4 left-4 bg-red-100 text-red-500 w-10 h-10 rounded-full shadow-lg z-50 flex items-center justify-center hover:bg-red-200 transition-colors">
             <i class="fas fa-times"></i>
        </button>
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center mx-4">
            <h2 class="text-2xl font-bold text-yellow-800 mb-2">Jij bent de Kiezer!</h2>
            <p class="text-gray-600 mb-6">Kies een object uit je omgeving.</p>
            <input id="inp-secret-word" type="text" class="game-input w-full p-3 rounded-lg mb-4 text-center text-lg" placeholder="Wat zie je? (het object)">
            <label class="block text-gray-700 text-sm font-bold mb-2 text-left">Kies de kleur van dit object:</label>
            <div class="flex items-center gap-4 mb-6">
                <input id="inp-secret-color" type="color" class="h-16 w-full cursor-pointer rounded-lg border-2 border-gray-200 p-1" value="#fbbf24">
            </div>
            <button id="btn-confirm-setup" class="btn-primary w-full py-3 rounded-lg text-lg">Bevestigen</button>
        </div>
    </div>

    <!-- 5. WAITING SCREEN -->
    <div id="screen-waiting-setup" class="screen bg-gray-100">
        <div class="text-center p-4">
            <div class="cheese-spinner mb-4">üëÄ</div>
            <h2 id="waiting-title" class="text-xl font-bold text-gray-700">De tegenspeler kiest...</h2>
            <p class="text-gray-500">Moment geduld a.u.b.</p>
        </div>
    </div>

    <!-- 6. GAME SCREEN (GUESSER - Classic) -->
    <div id="screen-game-guesser" class="screen transition-colors duration-500 overflow-hidden">
        <button id="btn-leave-guesser" class="absolute top-4 left-4 bg-red-100 text-red-500 w-10 h-10 rounded-full shadow-lg z-50 flex items-center justify-center hover:bg-red-200 transition-colors">
             <i class="fas fa-times"></i>
        </button>
        <!-- Floating Words Container for Guesser -->
        <div id="guesser-words-container" class="absolute inset-0 overflow-hidden pointer-events-none z-0"></div>

        <div class="absolute inset-0 flex flex-col justify-center items-center p-4 z-10">
            
            <div class="bg-white/95 p-6 rounded-2xl shadow-2xl w-full max-w-lg backdrop-blur-sm border border-white/20">
                <h3 class="text-center text-gray-800 font-bold mb-4">Raad het object met deze kleur!</h3>
                
                <div id="guesser-hint-box" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4 rounded" role="alert">
                    <p class="font-bold">Hint:</p>
                    <p id="guesser-hint-text">...</p>
                </div>

                <!-- DYNAMIC COMMENTARY BOX -->
                <div id="dynamic-comment-container" class="mb-4 h-auto min-h-[2rem] flex items-center justify-center">
                    <span id="dynamic-comment" class="text-lg font-bold text-pink-600 italic text-center leading-tight p-1"></span>
                </div>

                <div class="flex gap-2">
                    <input id="inp-guess" type="text" class="game-input flex-1 p-3 rounded-lg text-lg" placeholder="Wat is het?" autocomplete="off">
                    <button id="btn-submit-guess" class="bg-green-500 text-white font-bold px-6 rounded-lg hover:bg-green-600 shadow-md active:bg-green-700"><i class="fas fa-check"></i></button>
                </div>
                
                <div class="mt-4 flex justify-between items-center h-8">
                    <span id="guess-feedback" class="text-red-500 font-bold"></span>
                    <button id="btn-request-hint" class="text-blue-500 hover:text-blue-700 text-sm font-semibold underline p-2 rounded hover:bg-blue-50"><i class="far fa-lightbulb mr-1"></i>Hint vragen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. GAME SCREEN (SEEKER - Classic) -->
    <div id="screen-game-seeker" class="screen bg-gray-50 overflow-hidden">
        <button id="btn-leave-seeker" class="absolute top-4 left-4 bg-red-100 text-red-500 w-10 h-10 rounded-full shadow-lg z-50 flex items-center justify-center hover:bg-red-200 transition-colors">
             <i class="fas fa-times"></i>
        </button>
        <div id="wrong-guesses-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
        <div class="z-10 bg-white p-6 rounded-2xl shadow-xl text-center border-4 border-yellow-400 max-w-sm w-full mx-4">
            <h3 class="text-gray-500 text-sm uppercase tracking-wide">Het geheime woord</h3>
            <h1 id="seeker-secret-display" class="text-4xl font-bold text-gray-800 my-2">...</h1>
            <p class="text-gray-400 text-xs">Je tegenspeler is aan het raden...</p>
        </div>
        <!-- HINT MODAL -->
        <div id="seeker-hint-modal" class="absolute bottom-0 left-0 right-0 bg-white p-6 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform translate-y-full transition-transform duration-300 z-50">
            <h3 class="text-lg font-bold text-yellow-800 mb-2">üí° Hint Gevraagd!</h3>
            <p class="text-sm text-gray-600 mb-3">Geef een hint van 1 woord.</p>
            <div class="flex gap-2 pb-4"> 
                <button id="btn-ai-hint" class="sparkle-btn bg-purple-100 text-purple-700 border border-purple-300 px-3 rounded font-bold whitespace-nowrap"><i class="fas fa-magic"></i> AI Hint</button>
                <input id="inp-give-hint" type="text" class="game-input flex-1 p-3 rounded" placeholder="Hint...">
                <button id="btn-send-hint" class="bg-blue-500 text-white px-4 rounded font-bold">Stuur</button>
            </div>
        </div>
    </div>

    <!-- 8. WINNER SCREEN -->
    <div id="screen-winner" class="screen bg-green-100">
        <div class="text-center p-8 bg-white rounded-3xl shadow-xl max-w-md w-full mx-4">
            <div class="text-6xl mb-4" id="winner-icon">üéâ</div>
            <h1 class="text-3xl font-bold text-green-700 mb-2">Afgelopen!</h1>
            <p class="text-xl text-gray-700 mb-6" id="winner-text">... heeft gewonnen!</p>
            
            <div class="bg-gray-100 p-4 rounded-xl mb-6 hidden" id="classic-end-info">
                <p class="text-sm text-gray-500">Het woord was:</p>
                <p id="end-word" class="text-2xl font-bold text-gray-800">Brie</p>
            </div>

            <button id="btn-reset" class="btn-primary w-full py-4 rounded-lg text-lg shadow">
                Terug naar Lobby üîÑ
            </button>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG: Using user provided custom config
        const firebaseConfig = {
            apiKey: "AIzaSyBrJytboOjIzpTFHDLBrDlDrF8vIkJyqJ4",
            authDomain: "manonopeenrij.firebaseapp.com",
            projectId: "manonopeenrij",
            storageBucket: "manonopeenrij.firebasestorage.app",
            messagingSenderId: "575065794428",
            appId: "1:575065794428:web:81fc2519d23da55bf3e6f9",
            measurementId: "G-7K1J5VCDG7"
        };
        
        // Gemini API Key (Runtime Provided)
        const apiKey = ""; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let myRole = null; 
        let renderedGuessesCount = 0;
        let currentSecretWord = "";
        let spamInterval = null; 
        const appId = "ik-zie-ik-zie-manon";
        let authTimeout = null;
        
        // AI State
        let aiLoop = null; // Interval for AI guesser
        const aiVocab = [
            { word: "Banaan", color: "#fcd34d" }, // yellow
            { word: "Zon", color: "#fcd34d" },
            { word: "Appel", color: "#ef4444" }, // red
            { word: "Brandweerauto", color: "#ef4444" },
            { word: "Gras", color: "#22c55e" }, // green
            { word: "Kikker", color: "#22c55e" },
            { word: "Lucht", color: "#3b82f6" }, // blue
            { word: "Sneeuw", color: "#ffffff" }, // white
            { word: "Kool", color: "#000000" }, // black
            { word: "Sinaasappel", color: "#f97316" }, // orange
            { word: "Druif", color: "#a855f7" }, // purple
            { word: "Kaas", color: "#fbbf24" } 
        ];

        // Settings State
        let sfxEnabled = true;
        let isDarkMode = false;
        
        // Local scare state to prevent looping on snapshot updates
        let isScaring = false;

        // Minigame State
        let cheeseGameLoop = null;
        let cheeseSpawnInterval = null;
        let cheeseLives = 3;
        let cheeseScore = 0;
        let cheeseFlies = [];
        let cheeseGameActive = false;
        let cheeseCatActive = false; // Boost state
        let cheeseStartTime = 0; // NEW: Timer tracking
        let currentSurvivalTime = 0; // NEW: Holds final time

        // Audio Context Setup
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        let bgMusic; // Background music
        let scareAudio = null;
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            // Init Background Music
            if (!bgMusic) {
                bgMusic = new Audio('Boodschappenlied.mp3');
                bgMusic.loop = true;
                bgMusic.volume = 0.4; // Background volume
                bgMusic.play().catch(e => console.log("Autoplay blocked/File not found", e));
            }
            
            // Pre-load Scare Audio with Mobile Unlock Hack
            if (!scareAudio) {
                scareAudio = new Audio('scream.mp3');
                
                // UNLOCK HACK FOR MOBILE:
                // Play muted immediately to unlock the audio channel on user gesture
                scareAudio.volume = 0;
                scareAudio.play().then(() => {
                    scareAudio.pause();
                    scareAudio.currentTime = 0;
                    scareAudio.volume = 1.0; // Reset volume for actual use
                }).catch(e => {
                    // Allowed to fail if no user interaction yet, will try again on next init
                });
            }
        }
        
        // Simple SFX Synthesizer
        const sfx = {
            playTone: (freq, type, duration, startTime = 0) => {
                if (!audioCtx || !sfxEnabled) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(audioCtx.currentTime + startTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + startTime + duration);
                osc.stop(audioCtx.currentTime + startTime + duration);
            },
            win: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(523.25, 'triangle', 0.2, 0); // C5
                sfx.playTone(659.25, 'triangle', 0.2, 0.2); // E5
                sfx.playTone(783.99, 'triangle', 0.4, 0.4); // G5
                sfx.playTone(1046.50, 'triangle', 0.6, 0.6); // C6
            },
            lose: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(150, 'sawtooth', 0.3);
            },
            wrong: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(100, 'sawtooth', 0.2);
            },
            splat: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(50, 'square', 0.1);
            },
            damage: () => {
                 if (!audioCtx || !sfxEnabled) return;
                 sfx.playTone(200, 'sawtooth', 0.3);
            },
            buy: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(880, 'sine', 0.1);
                sfx.playTone(1760, 'sine', 0.1, 0.1);
            },
            troll: () => {
                if (!audioCtx || !sfxEnabled) return;
                for(let i=0; i<5; i++) {
                    sfx.playTone(Math.random() * 800 + 200, 'square', 0.1, i * 0.1);
                }
            },
            spam: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(800, 'square', 0.05);
            },
            sparkle: () => {
                if (!audioCtx || !sfxEnabled) return;
                sfx.playTone(1200, 'sine', 0.1);
                sfx.playTone(1500, 'sine', 0.1, 0.1);
            }
        };

        // DOM Elements
        const screens = {
            loading: document.getElementById('screen-loading'),
            login: document.getElementById('screen-login'),
            lobby: document.getElementById('screen-lobby'),
            setup: document.getElementById('screen-setup'),
            waitingSetup: document.getElementById('screen-waiting-setup'),
            gameGuesser: document.getElementById('screen-game-guesser'),
            gameSeeker: document.getElementById('screen-game-seeker'),
            winner: document.getElementById('screen-winner'),
            cheeseMinigame: document.getElementById('screen-minigame-cheese')
        };

        // Initialize Audio on user interaction
        document.body.addEventListener('click', initAudio, { once: true });
        document.body.addEventListener('touchstart', initAudio, { once: true });

        // --- GEMINI AI HELPERS ---
        async function callGemini(promptText) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });
                
                if (!response.ok) {
                    console.error("Gemini API Error:", response.status, response.statusText);
                    return null;
                }

                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("Gemini AI Error:", error);
                return null;
            }
        }

        async function getAIComment(guess, secret) {
            const prompt = `
                Je bent een gemene, botte spelhost bij 'Ik zie ik zie wat jij niet ziet'.
                De speler deed een gok: '${guess}'. Dit is volledig fout.
                Opdracht: Brand de speler af. Wees sarcastisch, bijdehand en meedogenloos.
                Zeg bijvoorbeeld dat ze een bril nodig hebben of dat de gok nergens op slaat.
                Geef GEEN hints. Noem het echte woord NIET.
                Max 12 woorden. Nederlands.
            `;
            
            const aiResponse = await callGemini(prompt);
            return aiResponse ? aiResponse.trim() : "Fout geraden! ü§ñ";
        }

        // --- Helper Functions ---
        function showScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.remove('active'));
            screens[screenName].classList.add('active');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.remove('hidden');
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function showLoadingError(msg) {
            document.querySelector('.cheese-spinner').classList.add('hidden');
            document.getElementById('loading-text').classList.add('hidden');
            const errDiv = document.getElementById('loading-error');
            document.getElementById('error-details').innerText = msg;
            errDiv.classList.remove('hidden');
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // Safe spawn for Guesser to avoid center input
        function getSafePosition(avoidCenter = false) {
            if (!avoidCenter) {
                const top = Math.random() * 80 + 10; 
                const left = Math.random() * 80 + 10; 
                return { top: top + '%', left: left + '%' };
            } else {
                // Return positions in 4 edge zones: Top, Bottom, Left, Right
                const zones = ['top', 'bottom', 'left', 'right'];
                const zone = zones[Math.floor(Math.random() * zones.length)];
                let top, left;

                // Margins to keep it safe from center card
                // Card is roughly center 50x50 area
                if(zone === 'top') {
                     top = Math.random() * 20 + 5; // 5% to 25%
                     left = Math.random() * 90 + 5;
                } else if(zone === 'bottom') {
                     top = Math.random() * 20 + 75; // 75% to 95%
                     left = Math.random() * 90 + 5;
                } else if (zone === 'left') {
                     top = Math.random() * 90 + 5;
                     left = Math.random() * 15 + 2; // 2% to 17%
                } else { // right
                     top = Math.random() * 90 + 5;
                     left = Math.random() * 15 + 83; // 83% to 98%
                }
                
                return { top: top + '%', left: left + '%' };
            }
        }

        function getRandomPosition() {
            // Legacy for Seeker (doesn't have input in middle covering things)
            const top = Math.random() * 80 + 10; 
            const left = Math.random() * 80 + 10; 
            return { top: top + '%', left: left + '%' };
        }

        // --- Cheese Confetti ---
        function startCheeseConfetti() {
            const icons = ['üßÄ', 'üçá', 'üç∑', 'ü•ñ', 'üéâ'];
            for(let i=0; i<30; i++) {
                const el = document.createElement('div');
                el.innerText = icons[Math.floor(Math.random() * icons.length)];
                el.classList.add('cheese-confetti');
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(el);
                
                // Cleanup
                setTimeout(() => el.remove(), 4000);
            }
        }

        // --- Screen Shake Helper ---
        function shakeScreen(hard = false) {
            document.body.classList.remove('shake-soft', 'shake-hard');
            void document.body.offsetWidth; // trigger reflow
            document.body.classList.add(hard ? 'shake-hard' : 'shake-soft');
            if(!hard) setTimeout(() => document.body.classList.remove('shake-soft'), 500);
            
            // Add native vibration for mobile
            if (navigator.vibrate) {
                navigator.vibrate(hard ? 500 : 200);
            }
        }

        // --- AUTH INIT ---
        async function initAuth() {
            const protocol = window.location.protocol;
            if (protocol === 'file:' || protocol === 'content:') {
                showLoadingError("Je opent dit bestand lokaal. Multiplayer vereist een webserver (https://).");
                return;
            }
            authTimeout = setTimeout(() => {
                if (!currentUser) showLoadingError("Verbinding duurt te lang. Controleer je internet of firewall.");
            }, 8000); 

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error", error);
                clearTimeout(authTimeout);
                showLoadingError("Login fout: " + error.message);
            }
        }
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                clearTimeout(authTimeout); 
                currentUser = user;
                showScreen('login');
            }
        });

        // --- SETTINGS LOGIC ---
        document.getElementById('btn-settings-toggle').addEventListener('click', () => {
            document.getElementById('settings-popup').classList.remove('hidden');
        });

        // Volume
        document.getElementById('inp-volume').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('vol-display').innerText = val + '%';
            if(bgMusic) bgMusic.volume = val / 100;
        });

        // SFX Toggle
        document.getElementById('btn-toggle-sfx').addEventListener('click', (e) => {
            sfxEnabled = !sfxEnabled;
            const btn = document.getElementById('btn-toggle-sfx');
            const dot = btn.querySelector('div');
            if(sfxEnabled) {
                btn.classList.remove('bg-gray-300'); btn.classList.add('bg-green-500');
                dot.style.transform = 'translateX(0)';
            } else {
                btn.classList.remove('bg-green-500'); btn.classList.add('bg-gray-300');
                dot.style.transform = 'translateX(-16px)';
            }
        });

        // Dark Mode
        document.getElementById('btn-toggle-dark').addEventListener('click', (e) => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('btn-toggle-dark');
            const dot = btn.querySelector('div');
            if(isDarkMode) {
                btn.classList.remove('bg-gray-300'); btn.classList.add('bg-indigo-500');
                dot.style.transform = 'translateX(16px)';
            } else {
                btn.classList.remove('bg-indigo-500'); btn.classList.add('bg-gray-300');
                dot.style.transform = 'translateX(0)';
            }
        });

        // Fullscreen
        document.getElementById('btn-fullscreen').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        });
        
        // --- LEAVE LOBBY / GAME LOGIC ---
        async function leaveGame() {
            if (!currentRoomId || !currentUser) return;
            
            try {
                // Fetch current room to remove self
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                const snap = await getDoc(roomRef);
                if (snap.exists()) {
                    const data = snap.data();
                    const newPlayers = data.players.filter(p => p.uid !== currentUser.uid);
                    
                    if (newPlayers.length === 0) {
                        // Keep room but maybe mark empty? For now just empty players
                    }
                    
                    await updateDoc(roomRef, { players: newPlayers });
                }
            } catch (e) {
                console.error("Leave error:", e);
            }
            
            // Reset Local State
            currentRoomId = null;
            if(unsubscribeRoom) unsubscribeRoom();
            if(aiLoop) { clearInterval(aiLoop); aiLoop = null; }
            renderedGuessesCount = 0;
            document.getElementById('guesser-words-container').innerHTML = '';
            document.getElementById('wrong-guesses-container').innerHTML = '';
            showScreen('login');
        }

        document.getElementById('btn-leave-lobby').addEventListener('click', leaveGame);
        document.getElementById('btn-leave-setup').addEventListener('click', leaveGame);
        document.getElementById('btn-leave-guesser').addEventListener('click', leaveGame);
        document.getElementById('btn-leave-seeker').addEventListener('click', leaveGame);

        // --- CHEESE MINIGAME LOGIC ---
        const cheeseItems = [
            { id: 1, name: "Grote Mepper", cost: 50, icon: "üèè", desc: "Groter klikbereik" },
            { id: 2, name: "Deo Spray", cost: 100, icon: "üß¥", desc: "Vliegen worden traag" },
            { id: 3, name: "De Huiskat", cost: 200, icon: "üê±", desc: "Vangt automatisch vliegen" },
            { id: 4, name: "Kaas Plakken", cost: 300, icon: "ü©π", desc: "+1 Leven" },
            { id: 5, name: "Manon's Schreeuw", cost: 500, icon: "üó£Ô∏è", desc: "Nuke alle vliegen!" }
        ];

        document.getElementById('btn-start-solo-game').addEventListener('click', startCheeseGame);
        document.getElementById('btn-exit-cheese').addEventListener('click', stopCheeseGame);
        document.getElementById('btn-quit-cheese').addEventListener('click', stopCheeseGame);
        document.getElementById('btn-retry-cheese').addEventListener('click', () => {
             document.getElementById('cheese-game-over').classList.add('hidden');
             startCheeseGame();
        });

        // HIGHSCORE LOGIC
        async function checkAndHandleHighscore(finalTime) {
            document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-gray-500 italic">Laden...</div>';
            document.getElementById('highscore-section').classList.add('hidden');
            
            try {
                // Fetch Highscores
                const highscoreRef = collection(db, 'artifacts', appId, 'public', 'data', 'highscores');
                const snapshot = await getDocs(highscoreRef); // Fetch all (small dataset assumption)
                let scores = [];
                snapshot.forEach(doc => scores.push(doc.data()));
                
                // Sort Descending (Time)
                scores.sort((a, b) => b.time - a.time);
                
                // Check if qualified for Top 10
                const isTop10 = scores.length < 10 || finalTime > scores[scores.length - 1].time;
                
                if (isTop10) {
                    document.getElementById('highscore-section').classList.remove('hidden');
                    // Focus input
                    setTimeout(() => document.getElementById('inp-highscore-name').focus(), 100);
                }
                
                renderLeaderboard(scores);
            } catch (e) {
                console.error("Leaderboard error", e);
                document.getElementById('leaderboard-list').innerText = "Fout bij laden.";
            }
        }
        
        function renderLeaderboard(scores) {
            // Take Top 10
            const top10 = scores.slice(0, 10);
            
            document.getElementById('leaderboard-list').innerHTML = top10.map((s, i) => `
                <div class="leaderboard-row flex justify-between items-center py-1 border-b border-gray-800 last:border-0">
                    <div class="flex items-center gap-2">
                        <span class="w-6 text-center opacity-50 font-mono">${i+1}.</span>
                        <span class="font-bold text-white truncate max-w-[120px]">${s.name}</span>
                    </div>
                    <span class="font-mono text-yellow-500">${formatTime(s.time)}</span>
                </div>
            `).join('');
            
            if (top10.length === 0) {
                 document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-gray-600 text-xs mt-2">Nog geen scores!</div>';
            }
        }
        
        document.getElementById('btn-submit-highscore').addEventListener('click', async () => {
            const name = document.getElementById('inp-highscore-name').value.trim();
            if (!name) return showToast("Vul je naam in!");
            
            const btn = document.getElementById('btn-submit-highscore');
            btn.disabled = true; btn.innerText = "...";
            
            try {
                // Save to Firestore
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'highscores'), {
                    name: name,
                    time: currentSurvivalTime,
                    date: Date.now()
                });
                
                // Refresh Leaderboard
                document.getElementById('highscore-section').classList.add('hidden');
                checkAndHandleHighscore(0); // Pass 0 so we just reload list, don't trigger input again
                showToast("Opgeslagen!");
            } catch (e) {
                showToast("Fout bij opslaan");
                console.error(e);
            }
            btn.disabled = false; btn.innerText = "Opslaan";
        });

        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const centis = Math.floor((ms % 1000) / 10);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${centis.toString().padStart(2, '0')}`;
        }

        function startCheeseGame() {
            initAudio();
            showScreen('cheeseMinigame');
            
            // Reset state
            cheeseLives = 3;
            cheeseScore = 0;
            cheeseFlies = [];
            cheeseGameActive = true;
            cheeseCatActive = false;
            cheeseStartTime = Date.now(); // Start Timer
            
            // Reset UI
            updateCheeseUI();
            document.getElementById('fly-container').innerHTML = '';
            document.getElementById('center-cheese').style.transform = 'translate(-50%, -50%) scale(1)';
            document.getElementById('cheese-timer-display').innerText = "00:00.00";
            
            // Render Shop
            renderShop();

            // Start Loops
            if(cheeseGameLoop) clearInterval(cheeseGameLoop);
            if(cheeseSpawnInterval) clearInterval(cheeseSpawnInterval);
            
            cheeseGameLoop = setInterval(updateCheeseGame, 1000/60); // 60fps
            cheeseSpawnInterval = setInterval(spawnFly, 2000); // Start slow
        }

        function stopCheeseGame() {
            cheeseGameActive = false;
            if(cheeseGameLoop) clearInterval(cheeseGameLoop);
            if(cheeseSpawnInterval) clearInterval(cheeseSpawnInterval);
            document.body.classList.remove('shake-soft', 'shake-hard'); // Force stop shake
            document.getElementById('cheese-game-over').classList.add('hidden');
            showScreen('lobby');
        }

        function renderShop() {
            const container = document.getElementById('shop-container');
            container.innerHTML = cheeseItems.map(item => `
                <button onclick="buyItem(${item.id})" class="flex-shrink-0 bg-yellow-100 border border-yellow-300 rounded-lg p-2 w-32 text-left hover:bg-yellow-200 active:scale-95 transition-transform">
                    <div class="text-xl mb-1">${item.icon}</div>
                    <div class="font-bold text-xs text-yellow-900 leading-tight">${item.name}</div>
                    <div class="text-[10px] text-gray-500">${item.cost} pnt</div>
                </button>
            `).join('');
        }
        
        // Expose to window for inline onclick
        window.buyItem = (id) => {
            const item = cheeseItems.find(i => i.id === id);
            if(cheeseScore >= item.cost) {
                cheeseScore -= item.cost;
                sfx.buy();
                applyBoost(id);
                updateCheeseUI();
            } else {
                showToast("Niet genoeg punten!");
            }
        };

        function applyBoost(id) {
            if(id === 1) { // Grote Mepper
                document.getElementById('fly-container').classList.add('cursor-crosshair'); // Visual cue
            }
            if(id === 2) { // Deo
                cheeseFlies.forEach(f => f.speed *= 0.5);
            }
            if(id === 3) { // Kat
                cheeseCatActive = true;
                showToast("De kat helpt mee!");
            }
            if(id === 4) { // Heal
                if(cheeseLives < 3) { cheeseLives++; updateCheeseVisuals(); }
            }
            if(id === 5) { // Nuke
                cheeseFlies.forEach(f => killFly(f.id));
                shakeScreen(true);
                setTimeout(() => document.body.classList.remove('shake-hard'), 500); // Temp shake for nuke
            }
        }

        function spawnFly() {
            if(!cheeseGameActive) return;
            if(cheeseFlies.length >= 6) return; // Reduced max flies from 10 to 6

            // Spawn at edge
            const side = Math.floor(Math.random() * 4); // 0:top, 1:right, 2:bottom, 3:left
            let x, y;
            if(side === 0) { x = Math.random() * window.innerWidth; y = -50; }
            if(side === 1) { x = window.innerWidth + 50; y = Math.random() * window.innerHeight; }
            if(side === 2) { x = Math.random() * window.innerWidth; y = window.innerHeight + 50; }
            if(side === 3) { x = -50; y = Math.random() * window.innerHeight; }

            const id = Date.now() + Math.random();
            const el = document.createElement('div');
            el.className = 'fly';
            el.innerHTML = 'ü™∞';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            // Click to kill
            el.onmousedown = (e) => { e.stopPropagation(); killFly(id); };
            el.ontouchstart = (e) => { e.stopPropagation(); killFly(id); };

            document.getElementById('fly-container').appendChild(el);
            
            cheeseFlies.push({
                id: id,
                el: el,
                x: x, 
                y: y,
                speed: 1 + (cheeseScore / 500) // Gets harder
            });
            
            // Difficulty ramp up - adjusted curve
            if(cheeseScore > 100) clearInterval(cheeseSpawnInterval);
            cheeseSpawnInterval = setInterval(spawnFly, Math.max(1000, 2500 - (cheeseScore * 0.8)));
        }

        function updateCheeseGame() {
            if(!cheeseGameActive) return;
            
            // Update Timer Display
            const now = Date.now();
            const elapsed = now - cheeseStartTime;
            document.getElementById('cheese-timer-display').innerText = formatTime(elapsed);

            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // Auto Cat Logic
            if(cheeseCatActive && Math.random() < 0.05 && cheeseFlies.length > 0) {
                killFly(cheeseFlies[0].id);
            }

            cheeseFlies.forEach((fly, index) => {
                // Move towards center
                const dx = centerX - fly.x;
                const dy = centerY - fly.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if(dist < 40) { // Hit Cheese
                    damageCheese();
                    fly.el.remove();
                    cheeseFlies.splice(index, 1);
                } else {
                    const moveX = (dx / dist) * fly.speed;
                    const moveY = (dy / dist) * fly.speed;
                    fly.x += moveX;
                    fly.y += moveY;
                    fly.el.style.left = fly.x + 'px';
                    fly.el.style.top = fly.y + 'px';
                    // Rotate to face center
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    fly.el.style.transform = `rotate(${angle + 90}deg)`;
                }
            });
        }

        function killFly(id) {
            const index = cheeseFlies.findIndex(f => f.id === id);
            if(index !== -1) {
                const fly = cheeseFlies[index];
                sfx.splat();
                fly.el.innerHTML = "üí•";
                fly.el.classList.add('dead');
                setTimeout(() => fly.el.remove(), 200);
                cheeseFlies.splice(index, 1);
                cheeseScore += 10;
                updateCheeseUI();
            }
        }

        function damageCheese() {
            cheeseLives--;
            sfx.damage();
            shakeScreen(true);
            setTimeout(() => document.body.classList.remove('shake-hard'), 500); // Remove shake after hit
            updateCheeseUI();
            updateCheeseVisuals();

            if(cheeseLives <= 0) {
                cheeseGameActive = false;
                sfx.lose();
                currentSurvivalTime = Date.now() - cheeseStartTime; // Capture Final Time
                document.getElementById('final-cheese-time').innerText = formatTime(currentSurvivalTime);
                document.getElementById('cheese-game-over').classList.remove('hidden');
                
                checkAndHandleHighscore(currentSurvivalTime);
            }
        }

        function updateCheeseVisuals() {
            const cheese = document.getElementById('center-cheese');
            let scale = 1;
            if(cheeseLives === 2) scale = 0.75;
            if(cheeseLives === 1) scale = 0.50;
            cheese.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        function updateCheeseUI() {
            let hearts = "";
            for(let i=0; i<cheeseLives; i++) hearts += "üßÄ"; // Using cheese instead of hearts is funnier, or stick to hearts
            document.getElementById('cheese-lives-display').innerText = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è".substring(0, cheeseLives*2); 
            document.getElementById('cheese-score-display').innerText = cheeseScore;
        }

        // --- Lobby Logic ---
        document.getElementById('btn-create-room').addEventListener('click', async () => {
            initAudio(); // Ensure audio context starts
            const name = document.getElementById('inp-name').value.trim() || "Speler 1";
            const code = generateRoomCode();
            currentRoomId = code;
            try {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
                await setDoc(roomRef, {
                    status: 'waiting',
                    createdAt: Date.now(),
                    gameMode: 'classic', 
                    players: [{ uid: currentUser.uid, name: name, isHost: true }],
                    chat: [], // Init chat array
                    gameData: {
                        secretWord: "", secretColor: "#ffffff", guesses: [],
                        hintRequested: false, hintGiven: "", winner: null,
                        trollEffect: null, trollData: null
                    }
                });
                enterLobby(code);
            } catch (e) {
                console.error(e);
                showToast("Fout bij maken kamer: " + e.message);
            }
        });

        document.getElementById('btn-join-room').addEventListener('click', async () => {
            initAudio(); // Ensure audio context starts
            const name = document.getElementById('inp-name').value.trim() || "Speler 2";
            const code = document.getElementById('inp-room-code').value.trim().toUpperCase();
            if (!code) return showToast("Vul een code in");
            try {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
                const snap = await getDoc(roomRef);
                if (!snap.exists()) return showToast("Kamer niet gevonden");
                const data = snap.data();
                if (data.status !== 'waiting') return showToast("Spel is al bezig");
                if (data.players.length >= 2 && !data.players.find(p => p.uid === currentUser.uid)) return showToast("Kamer is vol");
                if (!data.players.find(p => p.uid === currentUser.uid)) {
                    const newPlayers = [...data.players, { uid: currentUser.uid, name: name, isHost: false }];
                    await updateDoc(roomRef, { players: newPlayers });
                }
                currentRoomId = code;
                enterLobby(code);
            } catch (e) {
                console.error(e);
                showToast("Verbindingsfout");
            }
        });

        function enterLobby(code) {
            document.getElementById('lobby-code').innerText = code;
            showScreen('lobby');
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = onSnapshot(roomRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                handleRoomUpdate(data);
            });
        }

        // --- CHAT TOGGLE LOGIC ---
        document.getElementById('btn-chat-toggle').addEventListener('click', () => {
            const popup = document.getElementById('chat-popup');
            popup.classList.toggle('hidden');
            if(!popup.classList.contains('hidden')) {
                document.getElementById('chat-notification').classList.add('hidden');
                document.getElementById('inp-lobby-chat').focus();
            }
        });

        document.getElementById('btn-lobby-chat-send').addEventListener('click', sendChatMessage);
        document.getElementById('inp-lobby-chat').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        async function sendChatMessage() {
            const input = document.getElementById('inp-lobby-chat');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            // Fetch latest state to get my name
            const snap = await getDoc(roomRef);
            const me = snap.data().players.find(p => p.uid === currentUser.uid);
            const name = me ? me.name : "Onbekend";

            const msg = {
                uid: currentUser.uid,
                name: name,
                text: text,
                ts: Date.now()
            };

            await updateDoc(roomRef, {
                chat: arrayUnion(msg)
            });
            input.value = "";
            input.focus();
        }

        // --- AI BOT LOGIC ---
        document.getElementById('btn-add-ai').addEventListener('click', async () => {
            if(!currentRoomId) return showToast("Eerst een kamer joinen!");
            
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            const snap = await getDoc(roomRef);
            const players = snap.data().players;
            
            if(players.some(p => p.uid === 'ai-bot')) return showToast("AI is er al!");
            if(players.length >= 2) return showToast("Kamer is vol!");

            await updateDoc(roomRef, {
                players: arrayUnion({
                    uid: 'ai-bot',
                    name: 'Botje ü§ñ',
                    isHost: false
                })
            });
            
            // Close settings menu
            document.getElementById('settings-popup').classList.add('hidden');
            showToast("AI Bot toegevoegd!");
        });

        // --- AI HINT BUTTON ---
        document.getElementById('btn-ai-hint').addEventListener('click', async () => {
             const input = document.getElementById('inp-give-hint');
             input.placeholder = "‚ú® AI is aan het denken...";
             input.disabled = true;
             sfx.sparkle();
             
             // Get secret word
             const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
             const snap = await getDoc(roomRef);
             const secret = snap.data().gameData.secretWord;

             const prompt = `Het geheime woord is '${secret}'. Bedenk een cryptische, korte hint van max 1 zin voor het spel 'Ik zie ik zie wat jij niet ziet'. Antwoord in het Nederlands.`;
             const hint = await callGemini(prompt);
             
             input.disabled = false;
             if(hint) {
                 input.value = hint.trim();
                 input.focus();
             } else {
                 input.placeholder = "Fout bij AI...";
                 showToast("AI kon even niet denken!");
             }
        });

        // --- TROLL EFFECT HANDLER (Shared) ---
        function handleTrollEffects(data) {
            const effect = data.gameData.trollEffect; 
            const trollData = data.gameData.trollData;
            
            // RESET TROLLS IF NONE
            if (!effect) {
                document.body.classList.remove('troll-disco', 'troll-australia', 'troll-tiny', 'shake-hard');
                if (spamInterval) { clearInterval(spamInterval); spamInterval = null; }
                
                // Hide ManonScare logic if it was cleared
                document.getElementById('screen-scare').classList.add('hidden');
                isScaring = false;
                if(scareAudio) { scareAudio.pause(); scareAudio.currentTime = 0; }
            } else {
                // APPLY EFFECT
                if (effect === 'disco') document.body.classList.add('troll-disco');
                if (effect === 'australia') document.body.classList.add('troll-australia');
                if (effect === 'tiny') document.body.classList.add('troll-tiny');
                
                // MANONSCARE LOGIC
                if (effect === 'manonscare') {
                    if (!isScaring) {
                        isScaring = true;
                        document.getElementById('screen-scare').classList.remove('hidden');
                        if (scareAudio) {
                            scareAudio.currentTime = 0;
                            scareAudio.play().catch(e => console.log("Audio fail", e));
                        }
                        
                        // Local visual cleanup after 5s (even if DB still has effect, we stop showing it)
                        setTimeout(() => {
                            document.getElementById('screen-scare').classList.add('hidden');
                            if(scareAudio) { scareAudio.pause(); scareAudio.currentTime = 0; }
                        }, 5000);
                    }
                }
                
                // Troll Audio & Shake (Skip for manonscare to avoid double audio)
                if (effect !== 'manonscare' && !document.body.classList.contains('shake-hard')) {
                     sfx.troll();
                     shakeScreen(true);
                }

                if (effect === 'spam' && trollData && !spamInterval) {
                    const container = document.getElementById('wrong-guesses-container'); // Might need check for guesser container?
                    // Actually for Guesser, we can use their container or just overlay
                    // Let's use body or active screen container
                    const activeScreen = document.querySelector('.screen.active');
                    
                    spamInterval = setInterval(() => {
                        // Spam works best in Seeker screen visually, but let's make it universal
                        const el = document.createElement('div');
                        el.classList.add('floating-word'); el.innerText = trollData;
                        const pos = getSafePosition(false);
                        el.style.top = pos.top; el.style.left = pos.left; el.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;
                        el.style.zIndex = 1000; // Force on top
                        activeScreen.appendChild(el);
                        
                        sfx.spam(); // Beep on spam
                    }, 200);
                    setTimeout(() => { if (spamInterval) { clearInterval(spamInterval); spamInterval = null; } }, 10000);
                }
            }
        }

        // --- Game State Handler ---
        function handleRoomUpdate(data) {
            const players = data.players;
            currentSecretWord = data.gameData.secretWord;

            // BOT LOGIC: Ran by Host Only
            const amHost = players.find(p => p.uid === currentUser.uid)?.isHost;
            const hasBot = players.some(p => p.uid === 'ai-bot');

            if (amHost && hasBot) {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                
                // 1. AI as SEEKER
                if (data.status === 'setup' && data.seekerId === 'ai-bot' && !data.gameData.secretWord) {
                     // Set word after small delay
                     setTimeout(async () => {
                         const randomEntry = aiVocab[Math.floor(Math.random() * aiVocab.length)];
                         if(data.status === 'setup') { // Check again
                             await updateDoc(roomRef, { 
                                 status: 'playing', 
                                 'gameData.secretWord': randomEntry.word, 
                                 'gameData.secretColor': randomEntry.color 
                             });
                         }
                     }, 2000);
                }
                
                // 2. AI as GUESSER
                if (data.status === 'playing' && data.seekerId !== 'ai-bot') {
                    if (!aiLoop) {
                        aiLoop = setInterval(async () => {
                            // Check if game is still active locally
                            const currentSnap = await getDoc(roomRef);
                            if(!currentSnap.exists() || currentSnap.data().status !== 'playing') {
                                clearInterval(aiLoop);
                                aiLoop = null;
                                return;
                            }
                            
                            const secretColor = data.gameData.secretColor;
                            // Filter vocab for close-ish color matches or random
                            const potentialGuesses = aiVocab.filter(i => i.color === secretColor);
                            const guessObj = potentialGuesses.length > 0 
                                ? potentialGuesses[Math.floor(Math.random() * potentialGuesses.length)] 
                                : aiVocab[Math.floor(Math.random() * aiVocab.length)];
                            
                            const guess = guessObj.word;
                            
                            // Check win
                            if(guess.toLowerCase() === data.gameData.secretWord.toLowerCase()) {
                                 clearInterval(aiLoop); aiLoop = null;
                                 await updateDoc(roomRef, { 
                                     status: 'finished', 
                                     'gameData.winner': 'ai-bot', 
                                     'gameData.winnerName': 'Botje ü§ñ' 
                                 });
                            } else {
                                // Add guess
                                await updateDoc(roomRef, { 'gameData.guesses': arrayUnion(guess) });
                            }
                        }, 7000); // 7 seconds
                    }
                } else {
                    if(aiLoop) { clearInterval(aiLoop); aiLoop = null; }
                }
            } else {
                if(aiLoop) { clearInterval(aiLoop); aiLoop = null; }
            }


            // Chat Rendering
            const chatMessages = data.chat || [];
            const chatContainer = document.getElementById('lobby-chat-messages');
            if (chatContainer && data.status === 'waiting') {
                const wasScrolledToBottom = chatContainer.scrollHeight - chatContainer.scrollTop === chatContainer.clientHeight;
                
                if (chatMessages.length === 0) {
                    chatContainer.innerHTML = '<div class="text-center text-xs text-gray-400 italic mt-2">Nog geen berichten...</div>';
                } else {
                    const lastMsg = chatMessages[chatMessages.length - 1];
                    // Notification Logic
                    const popup = document.getElementById('chat-popup');
                    if(popup.classList.contains('hidden') && lastMsg.uid !== currentUser.uid) {
                        document.getElementById('chat-notification').classList.remove('hidden');
                    }

                    chatContainer.innerHTML = chatMessages.map(msg => {
                        const isMe = msg.uid === currentUser.uid;
                        return `<div class="chat-message ${isMe ? 'me' : 'them'}">
                            <div class="text-[10px] opacity-50 mb-0.5 leading-none">${msg.name}</div>
                            ${msg.text}
                        </div>`;
                    }).join('');
                    
                    if(wasScrolledToBottom) chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }
            
            // LOBBY STATE
            if (data.status === 'waiting') {
                showScreen('lobby'); 
                document.body.classList.remove('troll-disco', 'troll-australia', 'troll-tiny', 'shake-hard');
                const list = document.getElementById('player-list');
                list.innerHTML = players.map(p => 
                    `<div class="flex items-center gap-2 p-3 bg-white rounded shadow-sm border border-gray-100">
                        <div class="h-8 w-8 rounded-full bg-yellow-200 flex items-center justify-center font-bold text-yellow-700">${p.name.charAt(0)}</div>
                        <span class="font-medium text-gray-700">${p.name} ${p.uid === currentUser.uid ? '(Jij)' : ''}</span>
                    </div>`
                ).join('');
                
                const hostControls = document.getElementById('host-controls');
                const waitingMsg = document.getElementById('waiting-msg');
                const selSeeker = document.getElementById('sel-seeker');
                
                // HOST CONTROL LOGIC UPDATE
                if (amHost) {
                    hostControls.classList.remove('hidden'); 

                    if (players.length < 2) {
                        // LESS THAN 2 PLAYERS
                        // Hide Start Game
                        document.getElementById('btn-start-game').classList.add('hidden');
                        document.getElementById('sel-gamemode').parentElement.classList.add('hidden');
                        document.getElementById('sel-seeker').parentElement.classList.add('hidden');
                         
                        waitingMsg.classList.remove('hidden');
                        waitingMsg.innerText = "Wachten op speler 2...";
                    } else {
                        // ROOM FULL
                        document.getElementById('btn-start-game').classList.remove('hidden');
                        document.getElementById('sel-gamemode').parentElement.classList.remove('hidden');
                        document.getElementById('sel-seeker').parentElement.classList.remove('hidden');
                        
                        // Update Seeker Options
                        const currentVal = selSeeker.value;
                        selSeeker.innerHTML = players.map(p => `<option value="${p.uid}">${p.name}</option>`).join('');
                        if(currentVal && players.some(p => p.uid === currentVal)) selSeeker.value = currentVal;
                        
                        waitingMsg.classList.add('hidden');
                    }
                } else {
                    // NOT HOST
                    hostControls.classList.add('hidden');
                    waitingMsg.classList.remove('hidden');
                    if (players.length < 2) {
                         waitingMsg.innerText = "Wachten op speler 2...";
                    } else {
                        waitingMsg.innerText = "De host kiest de instellingen...";
                    }
                }
            }
            if (data.status === 'setup') {
                const seekerId = data.seekerId;
                myRole = (seekerId === currentUser.uid) ? 'seeker' : 'guesser';
                if (data.gameMode === 'classic') {
                    if (myRole === 'seeker') showScreen('setup');
                    else {
                        document.getElementById('waiting-title').innerText = "Speler zoekt een object...";
                        showScreen('waitingSetup');
                    }
                }
            }
            if (data.status === 'playing') {
                const seekerId = data.seekerId;
                myRole = (seekerId === currentUser.uid) ? 'seeker' : 'guesser';
                if (data.gameMode === 'classic') {
                    if (myRole === 'seeker') { updateSeekerScreen(data); showScreen('gameSeeker'); }
                    else { updateGuesserScreen(data); showScreen('gameGuesser'); }
                }
            }
            if (data.status === 'finished') {
                const previousStatus = document.getElementById('screen-winner').classList.contains('active') ? 'finished' : 'playing';
                if (previousStatus !== 'finished') {
                    sfx.win();
                    startCheeseConfetti();
                }

                document.body.classList.remove('troll-disco', 'troll-australia', 'troll-tiny', 'shake-hard');
                const winnerName = data.gameData.winnerName || "Iemand";
                document.getElementById('winner-text').innerHTML = `<span class="font-bold">${winnerName}</span> heeft gewonnen!`;
                if (data.gameMode === 'classic') {
                    document.getElementById('winner-icon').innerText = "üéâ";
                    document.getElementById('end-word').innerText = data.gameData.secretWord;
                    document.getElementById('classic-end-info').classList.remove('hidden');
                }
                showScreen('winner');
            }
        }

        document.getElementById('btn-start-game').addEventListener('click', async () => {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            const seekerId = document.getElementById('sel-seeker').value;
            const gameMode = document.getElementById('sel-gamemode').value;
            const updateData = {
                status: (gameMode === 'classic') ? 'setup' : 'playing',
                seekerId: seekerId, gameMode: gameMode,
                'gameData.guesses': [], 'gameData.hintRequested': false, 'gameData.hintGiven': "",
                'gameData.trollEffect': null, 'gameData.winner': null
            };
            await updateDoc(roomRef, updateData);
        });

        // --- CLASSIC GAMEPLAY LOGIC (Seeker/Guesser) ---
        document.getElementById('btn-confirm-setup').addEventListener('click', async () => {
            const word = document.getElementById('inp-secret-word').value.trim();
            const color = document.getElementById('inp-secret-color').value;
            if (!word) return showToast("Kies een woord!");
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            await updateDoc(roomRef, { status: 'playing', 'gameData.secretWord': word, 'gameData.secretColor': color });
        });

        function updateGuesserScreen(data) {
            const color = data.gameData.secretColor;
            document.getElementById('screen-game-guesser').style.backgroundColor = color;
            const hintBtn = document.getElementById('btn-request-hint');
            const hintBox = document.getElementById('guesser-hint-box');
            
            // Apply Trolls (Shared Logic)
            handleTrollEffects(data);

            // SHOW GUESSES FOR GUESSER TOO (Safe Zone Logic)
            const guesses = data.gameData.guesses || [];
            if (guesses.length > renderedGuessesCount) {
                // Ensure we are currently viewing the guesser screen before spawning
                if(document.getElementById('screen-game-guesser').classList.contains('active')) {
                     const container = document.getElementById('guesser-words-container');
                     // Only spawn the *new* ones since last render
                     for (let i = renderedGuessesCount; i < guesses.length; i++) {
                         spawnFloatingWord(guesses[i], container, true); // true = avoid center
                     }
                }
            }

            if (data.gameData.hintRequested && !data.gameData.hintGiven) {
                hintBtn.innerText = "Hint aangevraagd..."; hintBtn.disabled = true; hintBtn.classList.add('text-gray-400');
            } else if (data.gameData.hintGiven) {
                hintBox.classList.remove('hidden'); document.getElementById('guesser-hint-text').innerText = data.gameData.hintGiven; hintBtn.style.display = 'none';
            }
            
            // Update counter locally if I am guesser
            if(myRole === 'guesser') renderedGuessesCount = guesses.length;
        }

        function updateSeekerScreen(data) {
            document.getElementById('seeker-secret-display').innerText = data.gameData.secretWord;
            const guesses = data.gameData.guesses || [];
            if (guesses.length > renderedGuessesCount) {
                const container = document.getElementById('wrong-guesses-container');
                for (let i = renderedGuessesCount; i < guesses.length; i++) spawnFloatingWord(guesses[i], container, false);
                
                // Audio & Shake for wrong guesses
                if (renderedGuessesCount > 0) { // skip initial load
                    sfx.wrong();
                    shakeScreen(false);
                }
                renderedGuessesCount = guesses.length;
            }
            
            // Apply Trolls (Shared Logic)
            handleTrollEffects(data);

            const hintModal = document.getElementById('seeker-hint-modal');
            if (data.gameData.hintRequested && !data.gameData.hintGiven) hintModal.classList.remove('translate-y-full');
            else hintModal.classList.add('translate-y-full');
        }

        function spawnFloatingWord(text, container, avoidCenter = false) {
            const el = document.createElement('div');
            el.classList.add('floating-word'); el.innerText = text;
            // Use safe position if avoidCenter is true (for Guesser)
            const pos = getSafePosition(avoidCenter); 
            el.style.top = pos.top; el.style.left = pos.left; el.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;
            container.appendChild(el);
        }

        // --- DYNAMIC COMMENTARY GENERATOR ---
        // OLD FUNCTION DELETED: getSnarkyComment()

        function showDynamicComment(text) {
            const el = document.getElementById('dynamic-comment');
            el.innerText = text;
            el.classList.remove('comment-pop');
            void el.offsetWidth; // trigger reflow
            el.classList.add('comment-pop');
        }

        document.getElementById('btn-submit-guess').addEventListener('click', async () => {
            const inputEl = document.getElementById('inp-guess');
            const guess = inputEl.value.trim();
            if(!guess) return;
            if (guess.toLowerCase() === "hocus pocus") {
                inputEl.value = ""; document.getElementById('cheat-menu').classList.remove('hidden'); return;
            }
            
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            const snap = await getDoc(roomRef);
            const gameData = snap.data().gameData;
            
            if (guess.toLowerCase() === gameData.secretWord.toLowerCase()) {
                await updateDoc(roomRef, { status: 'finished', 'gameData.winner': currentUser.uid, 'gameData.winnerName': currentUser.displayName || "De Rader" });
            } else {
                // Show AI Dynamic Comment
                showDynamicComment("Even denken..."); // Loading state
                const comment = await getAIComment(guess, gameData.secretWord);
                showDynamicComment(comment);
                
                // Play wrong sound locally for immediate feedback
                sfx.wrong();
                shakeScreen(false);

                inputEl.value = "";
                inputEl.classList.add('border-red-500');
                document.getElementById('guess-feedback').innerText = "Fout!";
                setTimeout(() => { inputEl.classList.remove('border-red-500'); document.getElementById('guess-feedback').innerText = ""; }, 1000);
                await updateDoc(roomRef, { 'gameData.guesses': arrayUnion(guess) });
            }
        });

        // --- SHARED BUTTONS ---
        document.getElementById('btn-request-hint').addEventListener('click', async () => {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId); await updateDoc(roomRef, { 'gameData.hintRequested': true });
        });
        document.getElementById('btn-send-hint').addEventListener('click', async () => {
            const hint = document.getElementById('inp-give-hint').value.trim();
            if (!hint) return showToast("Vul iets in!");
            // 1-word limit check removed!
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId); await updateDoc(roomRef, { 'gameData.hintGiven': hint });
        });
        document.getElementById('btn-reset').addEventListener('click', async () => {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            await updateDoc(roomRef, {
                status: 'waiting', 'gameData.secretWord': '', 'gameData.secretColor': '#ffffff', 'gameData.guesses': [],
                'gameData.hintRequested': false, 'gameData.hintGiven': '', 'gameData.winner': null, 'gameData.winnerName': null,
                'gameData.trollEffect': null
            });
            renderedGuessesCount = 0; document.getElementById('wrong-guesses-container').innerHTML = ""; document.getElementById('guesser-words-container').innerHTML = "";
            document.getElementById('inp-guess').value = ""; document.getElementById('inp-secret-word').value = ""; document.getElementById('inp-give-hint').value = "";
            document.getElementById('guesser-hint-box').classList.add('hidden'); document.getElementById('dynamic-comment').innerText = "";
            document.getElementById('btn-request-hint').style.display = 'block'; document.getElementById('btn-request-hint').disabled = false;
        });

        // Cheat Menu Handlers
        async function triggerTroll(effect, data = null) {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            await updateDoc(roomRef, { 'gameData.trollEffect': effect, 'gameData.trollData': data });
            showToast("HACK ACTIVATED: " + effect.toUpperCase()); document.getElementById('cheat-menu').classList.add('hidden');
            setTimeout(async () => { await updateDoc(roomRef, { 'gameData.trollEffect': null, 'gameData.trollData': null }); }, 10000);
        }
        document.getElementById('btn-cheat-scare').addEventListener('click', () => triggerTroll('manonscare'));
        document.getElementById('btn-cheat-reveal').addEventListener('click', () => alert("HET ANTWOORD IS: " + currentSecretWord));
        document.getElementById('btn-cheat-hint').addEventListener('click', () => alert("HET BEGINT MET: " + currentSecretWord.charAt(0).toUpperCase()));
        document.getElementById('btn-cheat-disco').addEventListener('click', () => triggerTroll('disco'));
        document.getElementById('btn-cheat-australia').addEventListener('click', () => triggerTroll('australia'));
        document.getElementById('btn-cheat-tiny').addEventListener('click', () => triggerTroll('tiny'));
        document.getElementById('btn-cheat-spam').addEventListener('click', () => { const word = document.getElementById('inp-cheat-spam').value || "HA HA HA"; triggerTroll('spam', word); });
    </script>
</body>
</html>