<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>De Oude Herberg</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> <!-- Voor icons -->
    <style>
        /* --- SFEER & BASIS --- */
        body {
            font-family: 'Crimson Text', serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2, h3, .tavern-font { font-family: 'Cinzel', serif; }

        .background-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; object-fit: cover;
        }

        .main-scroll-container {
            width: 100%; height: 100%;
            overflow-y: auto;
            position: relative; z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            padding: 20px;
        }

        /* --- PERKAMENT STIJLEN --- */
        .parchment-box {
            background-color: #f4e4bc;
            background-image: url("https://www.transparenttextures.com/patterns/aged-paper.png");
            box-shadow: 0 4px 20px rgba(0,0,0,0.6), inset 0 0 60px rgba(160, 82, 45, 0.2);
            border-radius: 4px;
            border: 2px solid #d7c496;
            position: relative;
            display: flex; flex-direction: column;
        }

        /* --- TITEL --- */
        .main-title {
            font-size: 4rem; color: #f4e4bc;
            text-shadow: 4px 4px 0px #3e2723, 0 0 20px rgba(0,0,0,0.8);
            margin: 1rem 0 2rem 0; font-weight: 700; text-align: center;
        }

        /* --- KNOPPEN --- */
        .tavern-btn {
            background: #5d4037; color: #f4e4bc;
            border: 2px solid #3e2723;
            transition: all 0.2s ease; cursor: pointer;
            text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: bold;
        }
        .tavern-btn:hover {
            background: #795548; transform: scale(1.02); color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .tavern-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-small { padding: 4px 12px; font-size: 0.9rem; }

        /* --- LAYOUT GRID (3 Kolommen) --- */
        .tavern-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            width: 100%; max-width: 1400px;
            align-items: start; /* Belangrijk zodat ze niet uitrekken */
        }

        /* --- CHAT (LINKS) --- */
        .chat-area { height: 500px; }
        .chat-messages {
            flex-grow: 1; overflow-y: auto; padding: 10px;
            background: rgba(255,255,255,0.4); border: 1px solid rgba(62,39,35,0.2);
            margin-bottom: 10px; border-radius: 4px;
        }
        .chat-input {
            background: rgba(255,255,255,0.7); border: 2px solid #5d4037;
            padding: 8px; border-radius: 4px; width: 100%;
        }

        /* --- MENU (MIDDEN) --- */
        .menu-area { padding: 2rem; }

        /* --- SPELLEN (RECHTS) --- */
        .games-area { height: 500px; }
        .games-list {
            flex-grow: 1; overflow-y: auto;
            background: rgba(62,39,35,0.05); padding: 10px;
            border-radius: 4px; margin-bottom: 10px;
        }
        .game-card {
            background: rgba(255,255,255,0.6); padding: 10px; margin-bottom: 8px;
            border: 1px dashed #5d4037; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- GAME OVERLAY (MODAL) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #f4e4bc; padding: 20px; border-radius: 8px;
            max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto;
            border: 4px solid #5d4037; text-align: center;
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .tavern-grid { grid-template-columns: 1fr; max-width: 600px; }
            .main-title { font-size: 2.5rem; }
            /* Volgorde voor mobiel: Menu eerst, dan Spellen, dan Chat */
            .area-menu { order: 1; }
            .area-games { order: 2; }
            .area-chat { order: 3; }
        }
    </style>
</head>
<body>

    <!-- BACKGROUND -->
    <img src="tavern.png" class="background-layer" alt="Tavern Background" onerror="this.style.background='#2c1810'">

    <div class="main-scroll-container">
        <h1 class="main-title">De Oude Herberg</h1>

        <!-- 3-KOLOMMEN GRID -->
        <div class="tavern-grid">

            <!-- KOLOM 1: CHAT (Links op desktop, onderaan op mobiel) -->
            <div class="parchment-box area-chat chat-area p-4">
                <h2 class="text-2xl tavern-font text-amber-900 mb-2 border-b border-amber-900/30">Gesprekken</h2>
                <div id="chat-messages" class="chat-messages text-left text-sm">
                    <div class="text-center italic text-amber-900/50 mt-4">Laden...</div>
                </div>
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="message-input" class="chat-input" placeholder="Zeg iets..." autocomplete="off">
                    <button type="submit" class="tavern-btn px-4 rounded">></button>
                </form>
                <div id="user-status" class="text-xs text-amber-900/60 mt-1 text-center">...</div>
            </div>

            <!-- KOLOM 2: MENU (Midden) -->
            <div class="parchment-box area-menu menu-area text-center">
                <h2 class="text-3xl tavern-font text-amber-900 mb-6 border-b-2 border-amber-900/20 pb-2">Menu</h2>
                <div class="space-y-4">
                    <a href="kaas.html" class="tavern-btn w-full py-4 text-xl"><span>üßÄ</span> Ik zie ik zie...</a>
                    <a href="jungle.html" class="tavern-btn w-full py-4 text-xl"><span>ü¶Å</span> Raad het dier</a>
                    <div class="py-2 text-amber-900/40 text-sm border-t border-dashed border-amber-900/20 mt-4">
                        Meer spellen in de maak...
                    </div>
                </div>
            </div>

            <!-- KOLOM 3: MULTIPLAYER SPELLEN (Rechts) -->
            <div class="parchment-box area-games games-area p-4">
                <h2 class="text-2xl tavern-font text-amber-900 mb-2 border-b border-amber-900/30 flex justify-between items-center">
                    <span>Herberg Spellen</span>
                    <span class="text-xs bg-amber-900 text-white px-2 py-0.5 rounded-full">Online</span>
                </h2>
                
                <!-- Knoppen om spellen te maken -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="hostGame('tictactoe')" class="tavern-btn btn-small rounded py-2">‚ùå‚≠ï Boter Kaas</button>
                    <button onclick="hostGame('hangman')" class="tavern-btn btn-small rounded py-2">üî§ Galgje</button>
                    <button onclick="alert('De kaarten worden nog geschud! (Binnenkort beschikbaar)')" class="tavern-btn btn-small rounded py-2 opacity-70">üÉè Pesten</button>
                    <button class="tavern-btn btn-small rounded py-2 opacity-50 cursor-not-allowed">üé≤ Dobbelen</button>
                </div>

                <h3 class="text-sm font-bold text-amber-800 mb-1 uppercase tracking-wide">Open Tafels:</h3>
                <div id="games-list" class="games-list">
                    <div class="text-center italic text-amber-900/50 mt-4">Geen open spellen.<br>Start er een!</div>
                </div>
            </div>

        </div>
    </div>

    <!-- GAME MODAL (Overlay) -->
    <div id="game-modal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="closeGameModal()" class="absolute top-2 right-2 text-red-800 font-bold hover:text-red-600">‚úñ Sluiten</button>
            <div id="game-stage">
                <!-- Dynamische Game Content komt hier -->
            </div>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, orderBy, updateDoc, doc, deleteDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBrJytboOjIzpTFHDLBrDlDrF8vIkJyqJ4",
            authDomain: "manonopeenrij.firebaseapp.com",
            projectId: "manonopeenrij",
            storageBucket: "manonopeenrij.firebasestorage.app",
            messagingSenderId: "575065794428",
            appId: "1:575065794428:web:78a68f77a426f7daf3e6f9",
            measurementId: "G-ERGHXY3LR7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Globals
        let currentUser = null;
        let myUsername = localStorage.getItem('tavern_username') || ('Gast ' + Math.floor(Math.random()*1000));
        localStorage.setItem('tavern_username', myUsername);
        let activeGameListener = null;
        let currentGameId = null;

        // 2. AUTHENTICATION
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); return; } catch(e){}
                }
                await signInAnonymously(auth);
            } catch (err) { console.error("Auth failed", err); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('user-status').innerText = `Ingelogd als: ${myUsername}`;
                setupChat();
                setupGamesList();
            }
        });

        // 3. CHAT LOGIC
        function setupChat() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'chat'));
            onSnapshot(q, (snap) => {
                const msgs = [];
                snap.forEach(d => msgs.push({id: d.id, ...d.data()}));
                msgs.sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0));
                
                const html = msgs.map(m => `
                    <div class="mb-1 border-b border-amber-900/10 pb-1">
                        <span class="font-bold text-amber-900">${m.author}:</span>
                        <span class="text-amber-800">${escape(m.text)}</span>
                    </div>`).join('');
                const el = document.getElementById('chat-messages');
                el.innerHTML = html || '<div class="text-center italic opacity-50">Stil...</div>';
                el.scrollTop = el.scrollHeight;
            });
        }

        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const inp = document.getElementById('message-input');
            if(inp.value.trim() && currentUser) {
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
                    text: inp.value.trim(),
                    author: myUsername,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp()
                });
                inp.value = '';
            }
        });

        // 4. MULTIPLAYER LOBBY LOGIC
        window.hostGame = async (type) => {
            if(!currentUser) return alert("Even geduld, verbinden...");
            
            // Maak een nieuwe game doc
            const gameData = {
                type: type,
                host: myUsername,
                hostUid: currentUser.uid,
                status: 'waiting', // waiting, playing, finished
                timestamp: serverTimestamp(),
                state: getInitialState(type)
            };

            const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'games'), gameData);
            openGameUI(docRef.id, type, 'host');
        };

        function getInitialState(type) {
            if(type === 'tictactoe') return { board: Array(9).fill(''), turn: 'X', winner: null };
            if(type === 'hangman') return { word: '', guesses: [], mistakes: 0, setter: 'host', phase: 'setup' }; // phase: setup or guessing
            return {};
        }

        function setupGamesList() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'games'));
            onSnapshot(q, (snap) => {
                const listEl = document.getElementById('games-list');
                const games = [];
                snap.forEach(d => games.push({id: d.id, ...d.data()}));
                
                // Filter: alleen wachtende spellen en recente actieve spellen tonen
                const activeGames = games.filter(g => g.status === 'waiting' || (g.status === 'playing' && isMyGame(g)));
                
                if(activeGames.length === 0) {
                    listEl.innerHTML = '<div class="text-center italic text-amber-900/50 mt-4">Geen open spellen.</div>';
                    return;
                }

                listEl.innerHTML = activeGames.map(g => {
                    const isMine = g.hostUid === currentUser.uid;
                    const icon = g.type === 'tictactoe' ? '‚ùå‚≠ï' : 'üî§';
                    const btnText = isMine ? 'Wachten...' : 'Meespelen';
                    const btnClass = isMine ? 'opacity-50 cursor-default' : 'hover:bg-amber-700';
                    const action = isMine ? '' : `onclick="joinGame('${g.id}')"`;
                    
                    // Als ik al in dit spel zit en het is playing, toon "Hervatten"
                    if(g.status === 'playing' && (g.hostUid === currentUser.uid || g.guestUid === currentUser.uid)) {
                        return `<div class="game-card">
                            <span>${icon} vs ${g.host}</span>
                            <button onclick="rejoinGame('${g.id}', '${g.type}')" class="tavern-btn btn-small rounded bg-green-700">Hervatten</button>
                        </div>`;
                    }

                    return `
                    <div class="game-card">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-amber-900">${icon} ${g.type === 'tictactoe' ? 'Boter Kaas' : 'Galgje'}</span>
                            <span class="text-xs text-amber-900/60">Host: ${g.host}</span>
                        </div>
                        <button ${action} class="tavern-btn btn-small rounded ${btnClass}">${btnText}</button>
                    </div>`;
                }).join('');
            });
        }

        window.joinGame = async (gameId) => {
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId);
            await updateDoc(gameRef, {
                guestUid: currentUser.uid,
                guest: myUsername,
                status: 'playing'
            });
            // Haal type op om UI te openen (hacky manier zonder getDoc voor snelheid)
            // We vertrouwen erop dat de listener de UI update, maar we forceren open:
            // Voor nu even simpel: de snapshot in openGameUI handlet dit.
             // We moeten weten welk type het is.
             // Simpele fix: we openen de UI, de data laadt daar.
             openGameUI(gameId, null, 'guest'); 
        };

        window.rejoinGame = (id, type) => openGameUI(id, type, 'player');

        // 5. GAME PLAY UI
        window.closeGameModal = () => {
            document.getElementById('game-modal').style.display = 'none';
            if(activeGameListener) activeGameListener(); // Unsubscribe
            activeGameListener = null;
            currentGameId = null;
        };

        function openGameUI(gameId, typeHint, role) {
            currentGameId = gameId;
            const modal = document.getElementById('game-modal');
            const stage = document.getElementById('game-stage');
            modal.style.display = 'flex';
            stage.innerHTML = '<div class="text-2xl animate-pulse">Spel laden...</div>';

            activeGameListener = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'games', gameId), (docSnap) => {
                if(!docSnap.exists()) {
                    stage.innerHTML = "Spel is be√´indigd.";
                    setTimeout(closeGameModal, 2000);
                    return;
                }
                const game = docSnap.data();
                renderGame(game, docSnap.id);
            });
        }

        function renderGame(game, id) {
            const stage = document.getElementById('game-stage');
            const amIHost = game.hostUid === currentUser.uid;
            
            // Header
            let html = `<h2 class="text-3xl tavern-font mb-4 text-amber-900">${game.type === 'tictactoe' ? 'Boter, Kaas & Eieren' : 'Galgje'}</h2>`;
            html += `<div class="mb-4 text-amber-800">Spelers: <b>${game.host}</b> vs <b>${game.guest || 'Wachten...'}</b></div>`;

            if(game.status === 'waiting') {
                html += `<div class="p-8 border-2 border-dashed border-amber-900/30 rounded bg-amber-50">
                    <p class="animate-pulse">Wachten op tegenstander...</p>
                    <p class="text-sm mt-2">De code ligt op tafel, wie durft?</p>
                </div>`;
                stage.innerHTML = html;
                return;
            }

            // --- TICTACTOE RENDER ---
            if(game.type === 'tictactoe') {
                const board = game.state.board;
                const mySymbol = amIHost ? 'X' : 'O';
                const isMyTurn = game.state.turn === mySymbol;
                const winner = game.state.winner;

                let statusText = isMyTurn ? "Jouw beurt!" : `Wachten op ${amIHost ? game.guest : game.host}...`;
                if(winner) statusText = winner === 'DRAW' ? "Gelijkspel!" : (winner === mySymbol ? "Je hebt gewonnen! üéâ" : "Helaas, verloren.");

                html += `<div class="text-xl font-bold mb-4 ${isMyTurn ? 'text-green-700' : 'text-amber-900'}">${statusText}</div>`;
                
                html += `<div class="grid grid-cols-3 gap-2 w-64 mx-auto mb-4">`;
                board.forEach((cell, idx) => {
                    html += `<div onclick="tttMove('${id}', ${idx}, '${mySymbol}', ${isMyTurn && !winner})" 
                        class="w-20 h-20 bg-amber-100 border-2 border-amber-900 flex items-center justify-center text-4xl cursor-pointer hover:bg-amber-200">
                        ${cell}
                    </div>`;
                });
                html += `</div>`;
                if(winner) html += `<button onclick="deleteGame('${id}')" class="tavern-btn px-6 py-2 mx-auto mt-4 rounded">Sluit Spel</button>`;
            } 

            // --- HANGMAN RENDER ---
            else if(game.type === 'hangman') {
                const state = game.state;
                const isSetter = (state.setter === 'host' && amIHost) || (state.setter === 'guest' && !amIHost);
                
                if(state.phase === 'setup') {
                    if(isSetter) {
                        html += `<div class="flex flex-col gap-2">
                            <p>Kies een woord voor je tegenstander:</p>
                            <input type="text" id="hangman-word" class="p-2 border border-amber-900 rounded uppercase text-center" maxlength="10">
                            <button onclick="hangmanSetWord('${id}')" class="tavern-btn px-4 py-2 rounded">Bevestig Woord</button>
                        </div>`;
                    } else {
                        html += `<p class="animate-pulse">Tegenstander bedenkt een woord...</p>`;
                    }
                } else {
                    // Guessing Phase
                    const wordDisplay = state.word.split('').map(l => state.guesses.includes(l) ? l : '_').join(' ');
                    const won = !wordDisplay.includes('_');
                    const lost = state.mistakes >= 6;
                    
                    html += `<div class="text-4xl font-mono tracking-widest mb-6">${wordDisplay}</div>`;
                    html += `<div class="text-red-700 font-bold mb-4">Fouten: ${state.mistakes} / 6</div>`;

                    if(won || lost) {
                         const msg = won ? (isSetter ? "Ze hebben het geraden!" : "Je hebt gewonnen!") : (isSetter ? "Ze zijn opgehangen! Jij wint." : `Verloren! Het woord was ${state.word}`);
                         html += `<div class="text-2xl font-bold mb-4">${msg}</div>`;
                         html += `<button onclick="deleteGame('${id}')" class="tavern-btn px-6 py-2 mx-auto rounded">Sluit Spel</button>`;
                    } else if (!isSetter) {
                        // Keyboard for guesser
                        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
                        html += `<div class="flex flex-wrap gap-1 justify-center max-w-md mx-auto">`;
                        alphabet.forEach(letter => {
                            const used = state.guesses.includes(letter);
                            html += `<button onclick="hangmanGuess('${id}', '${letter}')" 
                                ${used ? 'disabled' : ''} 
                                class="w-8 h-8 border border-amber-900 rounded ${used ? 'bg-amber-900/20' : 'bg-amber-100 hover:bg-white'}">
                                ${letter}
                            </button>`;
                        });
                        html += `</div>`;
                    } else {
                        html += `<p>Je tegenstander is aan het raden...</p>`;
                    }
                }
            }

            stage.innerHTML = html;
        }

        // --- GAME ACTIONS ---
        
        // Tic Tac Toe Move
        window.tttMove = async (gameId, index, symbol, allowed) => {
            if(!allowed) return;
            
            // We need to read current state first to be safe (or pass complete state)
            // For simplicity we trust the click but ideally we use transactions.
            // Since we can't easily do transactions with just updateDoc on a deeply nested field without reading,
            // we rely on the visual state. *Proper implementation needs transaction*.
            // Here: Read from memory of last snapshot for responsiveness
            
            // Fetch fresh doc to be sure
            // NOTE: In strict Firestore, use runTransaction. Here simple update.
            // We assume 'game' variable is not available here globally easily without re-fetching or passing huge args.
            // Let's just do a quick hack: we assume the board passed in args logic is correct.
            
            // To do this right in 1 file:
            // We will fetch the doc inside this function.
            // Because we are inside a module, we can't easily access the 'game' object from render.
            // But we know the logic.
            
            // Actually, we can just update the specific field using dot notation? 
            // Firestore allows "state.board": ... but arrays are tricky.
            // Let's read, modify, write.
            // But we can't await inside the onclick easily in HTML string.
            // So we made the function async.
            
            // Wait, we need the doc data.
            // Let's just create a simplified transactional update helper.
            // Or simpler: The user clicks, we fetch, check, update.
            // It might be slightly slow but safer.
        };
        
        // BETTER IMPLEMENTATION FOR TTT MOVE (Attached to window)
        window.tttMove = async (id, idx, symbol, allowed) => {
            if(!allowed) return;
            // Optimistic UI update could go here
            
            // 1. Get current state
            // We need a ref.
            // Since we don't have the doc locally in this scope easily, we rely on a helper to get it or just use the global 'activeGameListener's last known state? No, that's messy.
            // Let's just getDoc. (Sorry Rule 2, but getDoc is fine for single doc).
            // Wait, I didn't import getDoc. I'll add it to imports or use a trick.
            // Trick: use `onSnapshot` once? No. 
            // I will add getDoc to imports in the script tag.
        };
        
        // Helper to update TTT
        // Since I cannot easily change the imports in the generated string block without regenerating everything, 
        // I will implement a "blind write" logic or use the `updateDoc` with logic if possible.
        // Actually, TTT logic requires knowing if the cell is empty.
        // I will add `getDoc` to the imports list in the code above.
        
        // Hangman Actions
        window.hangmanSetWord = async (id) => {
            const word = document.getElementById('hangman-word').value.toUpperCase().trim();
            if(word.length < 2) return alert("Te kort!");
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', id);
            await updateDoc(gameRef, {
                'state.word': word,
                'state.phase': 'guessing'
            });
        };

        window.hangmanGuess = async (id, letter) => {
             // We need to check if letter is in word.
             // This requires reading the doc.
             // See note below about getDoc.
        };
        
        window.deleteGame = async (id) => {
             await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'games', id));
             closeGameModal();
        };

        function escape(s) {
            return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
    
    <!-- EXTRA SCRIPT VOOR GAME LOGIC MET GETDOC (Import fix) -->
    <script type="module">
        import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyBrJytboOjIzpTFHDLBrDlDrF8vIkJyqJ4",
            authDomain: "manonopeenrij.firebaseapp.com",
            projectId: "manonopeenrij",
            storageBucket: "manonopeenrij.firebasestorage.app",
            messagingSenderId: "575065794428",
            appId: "1:575065794428:web:78a68f77a426f7daf3e6f9",
            measurementId: "G-ERGHXY3LR7"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // TTT LOGIC
        window.tttMove = async (id, idx, symbol, allowed) => {
            if(!allowed) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', id);
            const snap = await getDoc(ref);
            if(!snap.exists()) return;
            const data = snap.data();
            const state = data.state;
            
            if(state.board[idx] !== '') return; // Already taken
            
            state.board[idx] = symbol;
            state.turn = symbol === 'X' ? 'O' : 'X';
            
            // Check win
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            if(wins.some(c => state.board[c[0]] && state.board[c[0]] === state.board[c[1]] && state.board[c[0]] === state.board[c[2]])) {
                state.winner = symbol;
            } else if(!state.board.includes('')) {
                state.winner = 'DRAW';
            }
            
            await updateDoc(ref, { state: state });
        };

        // HANGMAN LOGIC
        window.hangmanGuess = async (id, letter) => {
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'games', id);
            const snap = await getDoc(ref);
            if(!snap.exists()) return;
            const data = snap.data();
            const state = data.state;

            if(state.guesses.includes(letter)) return;
            state.guesses.push(letter);
            
            if(!state.word.includes(letter)) {
                state.mistakes++;
            }
            
            await updateDoc(ref, { state: state });
        };
    </script>
</body>
</html>
